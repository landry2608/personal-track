import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Save, Home, BarChart, Settings, CheckCircle, XCircle, Plus, Edit2, Trash2 } from 'lucide-react';
import { Switch } from '@/components/ui/switch';

const MobileTracker = () => {
  // Structure de base pour une nouvelle catégorie
  const createEmptyCategory = () => ({
    objectif: '',
    realisation: '',
    status: ''
  });

  const [categories, setCategories] = useState([
    'famille',
    'sante',
    'entrepreneuriat'
  ]);

  const [activeTab, setActiveTab] = useState('today');
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [currentData, setCurrentData] = useState({});
  const [notificationsEnabled, setNotificationsEnabled] = useState(false);
  
  // États pour la gestion des catégories
  const [editingCategory, setEditingCategory] = useState(null);
  const [newCategoryName, setNewCategoryName] = useState('');
  const [isAddingCategory, setIsAddingCategory] = useState(false);

  useEffect(() => {
    // Chargement des catégories
    const savedCategories = localStorage.getItem('categories');
    if (savedCategories) {
      setCategories(JSON.parse(savedCategories));
    }

    // Chargement des données du jour
    const savedData = localStorage.getItem(`tracker_${selectedDate}`);
    if (savedData) {
      setCurrentData(JSON.parse(savedData));
    } else {
      const newData = categories.reduce((acc, category) => {
        acc[category] = createEmptyCategory();
        return acc;
      }, {});
      newData.reflexion = '';
      setCurrentData(newData);
    }
  }, [selectedDate]);

  const handleTaskChange = (category, field, value) => {
    setCurrentData(prev => {
      if (category === 'reflexion') {
        return { ...prev, reflexion: value };
      }
      return {
        ...prev,
        [category]: {
          ...prev[category],
          [field]: value
        }
      };
    });
  };

  const handleAddCategory = () => {
    if (newCategoryName.trim() && !categories.includes(newCategoryName.trim().toLowerCase())) {
      const updatedCategories = [...categories, newCategoryName.trim().toLowerCase()];
      setCategories(updatedCategories);
      localStorage.setItem('categories', JSON.stringify(updatedCategories));
      
      setCurrentData(prev => ({
        ...prev,
        [newCategoryName.trim().toLowerCase()]: createEmptyCategory()
      }));
      
      setNewCategoryName('');
      setIsAddingCategory(false);
    }
  };

  const startEditingCategory = (category) => {
    setEditingCategory(category);
    setNewCategoryName(category);
  };

  const handleEditCategory = () => {
    if (newCategoryName.trim() && editingCategory && newCategoryName.trim().toLowerCase() !== editingCategory) {
      // Mise à jour de la liste des catégories
      const updatedCategories = categories.map(cat => 
        cat === editingCategory ? newCategoryName.trim().toLowerCase() : cat
      );
      setCategories(updatedCategories);
      localStorage.setItem('categories', JSON.stringify(updatedCategories));

      // Mise à jour des données actuelles
      const updatedData = { ...currentData };
      updatedData[newCategoryName.trim().toLowerCase()] = updatedData[editingCategory];
      delete updatedData[editingCategory];
      setCurrentData(updatedData);

      // Mise à jour des données historiques
      Object.keys(localStorage)
        .filter(key => key.startsWith('tracker_'))
        .forEach(key => {
          const dayData = JSON.parse(localStorage.getItem(key));
          if (dayData[editingCategory]) {
            dayData[newCategoryName.trim().toLowerCase()] = dayData[editingCategory];
            delete dayData[editingCategory];
            localStorage.setItem(key, JSON.stringify(dayData));
          }
        });

      setEditingCategory(null);
      setNewCategoryName('');
    }
  };

  const handleDeleteCategory = (categoryToDelete) => {
    const updatedCategories = categories.filter(cat => cat !== categoryToDelete);
    setCategories(updatedCategories);
    localStorage.setItem('categories', JSON.stringify(updatedCategories));

    // Suppression des données de la catégorie
    const updatedData = { ...currentData };
    delete updatedData[categoryToDelete];
    setCurrentData(updatedData);
  };

  const saveData = () => {
    localStorage.setItem(`tracker_${selectedDate}`, JSON.stringify(currentData));
  };

  const renderTodayView = () => (
    <div className="space-y-4">
      <div className="flex items-center justify-between mb-4">
        <Input
          type="date"
          value={selectedDate}
          onChange={(e) => setSelectedDate(e.target.value)}
          className="w-40"
        />
      </div>
      
      {categories.map(category => (
        <Card key={category} className="mb-4">
          <CardHeader>
            {editingCategory === category ? (
              <div className="flex items-center gap-2">
                <Input
                  value={newCategoryName}
                  onChange={(e) => setNewCategoryName(e.target.value)}
                  className="flex-1"
                />
                <Button onClick={handleEditCategory} size="sm">
                  Valider
                </Button>
                <Button 
                  variant="outline" 
                  size="sm"
                  onClick={() => {
                    setEditingCategory(null);
                    setNewCategoryName('');
                  }}
                >
                  Annuler
                </Button>
              </div>
            ) : (
              <div className="flex items-center justify-between">
                <CardTitle className="text-lg font-semibold capitalize">
                  {category}
                </CardTitle>
                <div className="flex gap-2">
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => startEditingCategory(category)}
                    className="h-8 w-8"
                  >
                    <Edit2 className="h-4 w-4 text-gray-500" />
                  </Button>
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => handleDeleteCategory(category)}
                    className="h-8 w-8"
                  >
                    <Trash2 className="h-4 w-4 text-red-500" />
                  </Button>
                </div>
              </div>
            )}
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <label className="text-sm font-medium">Objectif</label>
              <Input
                value={currentData[category]?.objectif || ''}
                onChange={(e) => handleTaskChange(category, 'objectif', e.target.value)}
                placeholder={`Objectif ${category}`}
                className="mt-1"
              />
            </div>
            <div>
              <label className="text-sm font-medium">Réalisation</label>
              <Input
                value={currentData[category]?.realisation || ''}
                onChange={(e) => handleTaskChange(category, 'realisation', e.target.value)}
                placeholder="Ce que j'ai accompli"
                className="mt-1"
              />
            </div>
            <div>
              <label className="text-sm font-medium mb-2 block">Statut</label>
              <div className="flex gap-2">
                <Button
                  variant={currentData[category]?.status === 'Atteint' ? "default" : "outline"}
                  onClick={() => handleTaskChange(category, 'status', 'Atteint')}
                  className="flex items-center gap-2"
                >
                  <CheckCircle className="w-4 h-4" />
                  Atteint
                </Button>
                <Button
                  variant={currentData[category]?.status === 'Non atteint' ? "default" : "outline"}
                  onClick={() => handleTaskChange(category, 'status', 'Non atteint')}
                  className="flex items-center gap-2"
                >
                  <XCircle className="w-4 h-4" />
                  Non atteint
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>
      ))}

      {isAddingCategory ? (
        <Card className="mb-4">
          <CardContent className="pt-4">
            <div className="flex gap-2">
              <Input
                value={newCategoryName}
                onChange={(e) => setNewCategoryName(e.target.value)}
                placeholder="Nom de la nouvelle catégorie"
                className="flex-1"
              />
              <Button onClick={handleAddCategory}>Ajouter</Button>
              <Button 
                variant="outline" 
                onClick={() => {
                  setIsAddingCategory(false);
                  setNewCategoryName('');
                }}
              >
                Annuler
              </Button>
            </div>
          </CardContent>
        </Card>
      ) : (
        <Button
          onClick={() => setIsAddingCategory(true)}
          className="w-full mb-4"
          variant="outline"
        >
          <Plus className="w-4 h-4 mr-2" />
          Ajouter une catégorie
        </Button>
      )}

      <Card>
        <CardHeader>
          <CardTitle className="text-lg font-semibold">Réflexion</CardTitle>
        </CardHeader>
        <CardContent>
          <Textarea
            value={currentData.reflexion || ''}
            onChange={(e) => handleTaskChange('reflexion', '', e.target.value)}
            placeholder="Ce que je retiens de ma journée..."
            className="min-h-24"
          />
        </CardContent>
      </Card>

      <Button onClick={saveData} className="w-full">
        <Save className="w-4 h-4 mr-2" />
        Sauvegarder
      </Button>
    </div>
  );

  return (
    <div className="flex flex-col h-screen bg-gray-50">
      <header className="bg-blue-600 text-white p-4">
        <h1 className="text-xl font-bold text-center">Planning Personnel</h1>
      </header>
      
      <main className="flex-1 overflow-y-auto p-4">
        {activeTab === 'today' && renderTodayView()}
        {activeTab === 'stats' && <div>Statistiques à venir</div>}
        {activeTab === 'settings' && (
          <div className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle className="text-lg">Réglages</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="font-medium">Rappel quotidien</h3>
                    <p className="text-sm text-gray-500">
                      Notification à 21h00 pour planifier vos objectifs
                    </p>
                  </div>
                  <Switch
                    checked={notificationsEnabled}
                    onCheckedChange={setNotificationsEnabled}
                  />
                </div>
              </CardContent>
            </Card>
          </div>
        )}
      </main>
      
      <nav className="border-t border-gray-200 bg-white">
        <div className="flex justify-around p-2">
          <Button
            variant={activeTab === 'today' ? 'default' : 'ghost'}
            onClick={() => setActiveTab('today')}
            className="flex-1 flex flex-col items-center py-2"
          >
            <Home className="w-5 h-5 mb-1" />
            <span className="text-xs">Aujourd'hui</span>
          </Button>
          <Button
            variant={activeTab === 'stats' ? 'default' : 'ghost'}
            onClick={() => setActiveTab('stats')}
            className="flex-1 flex flex-col items-center py-2"
          >
            <BarChart className="w-5 h-5 mb-1" />
            <span className="text-xs">Statistiques</span>
          </Button>
          <Button
            variant={activeTab === 'settings' ? 'default' : 'ghost'}
            onClick={() => setActiveTab('settings')}
            className="flex-1 flex flex-col items-center py-2"
          >
            <Settings className="w-5 h-5 mb-1" />
            <span className="text-xs">Réglages</span>
          </Button>
        </div>
      </nav>
    </div>
  );
};

export default MobileTracker;
